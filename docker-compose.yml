version: '3.8'

services:
  frontend:
    build:
      context: ./tpf-frontend  # Asegúrate de que esta ruta sea correcta
    ports:
      - "4200:4200"  # Asegúrate de mapear correctamente el puerto 4200
    networks:
      - my-network

  backend:
    build:
      context: ./tpf-backend
    environment:
      - NODE_ENV=production
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USER=root  # Usuario de la base de datos
      - DB_PASSWORD=root  # Contraseña de la base de datos
      - DB_NAME=tpf_db_d  # Nombre de la base de datos
    depends_on:
      - mysql
    networks:
      - my-network
    ports:
      - "3000:3000"

  mysql:
    image: mysql:latest  # Imagen oficial de MySQL
    environment:
      MYSQL_ROOT_PASSWORD: root  # Contraseña del root
      #MYSQL_USER: root  # Usuario de la base de datos
      #MYSQL_PASSWORD: PVisual23/9-  # Contraseña de la base de datos
      MYSQL_DATABASE: tpf_db_d  # Nombre de la base de datos
    volumes:
      - mysql-data:/var/lib/mysql  # Volumen persistente para los datos
      - ./backup.sql:/docker-entrypoint-initdb.d/backup.sql  # Montar el archivo SQL para restaurar
    networks:
      - my-network
    ports:
      - "3307:3306"  # Exponer el puerto 3306 para conexiones externas
  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest  # Imagen oficial de phpMyAdmin
    container_name: phpmyadmin
    environment:
      PMA_HOST: mysql  # Nombre del servicio MySQL definido arriba
      PMA_PORT: 3306   # Puerto del servicio MySQL
      MYSQL_ROOT_PASSWORD: root  # Contraseña del root
    depends_on:
      - mysql
    networks:
      - my-network
    ports:
      - "8080:80"  # Puerto para acceder a phpMyAdmin desde el navegador

  backup:
    image: mysql:latest  # Usa la misma imagen de MySQL
    container_name: mysql-backup
    volumes:
      - mysql-backups:/backups  # Volumen Docker para almacenar backups 
      - C:/Users/Cristian/Downloads/tpf-hia/backup.sql:/docker-entrypoint-initdb.d/backup.sql  # Monta el script en el contenedor     
    depends_on:
      - mysql
    entrypoint: ["/bin/bash", "-c", "chmod +x /usr/local/bin/backup.sh && while true; do /usr/local/bin/backup.sh; sleep 86400; done"]
    networks:
      - my-network

networks:
  my-network:

volumes:
  mysql-data:
  mysql-backups:  # Volumen específico para backups